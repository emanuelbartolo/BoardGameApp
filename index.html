<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spiele, Bier & Brezel üé≤üç∫ü•®</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css?v=2.3">
</head>
<body>
    <!-- Top strip: login info and language on the very top (moved above banner) -->
    <div class="top-strip py-1">
        <div class="container d-flex justify-content-between align-items-center">
            <div class="me-1">
                <div class="d-flex align-items-center">
                    <select id="language-switcher" class="form-select form-select-sm me-2">
                    <option value="en">EN</option>
                    <option value="de">DE</option>
                </select>
                    <button id="group-join-btn" class="btn btn-sm btn-outline-primary d-none" type="button" data-i18n-key="group_join_button">Join Group</button>
                    <button id="active-group-display" class="btn btn-sm btn-outline-primary d-none ms-2" type="button" aria-pressed="false"><span data-i18n-key="group_label">Group:</span> <strong data-i18n-key="default_group_name">Default Group</strong></button>
                </div>
            </div>
            <div class="d-flex align-items-center">
                <div id="user-display" class="d-flex align-items-center"></div>
            </div>
        </div>
    </div>

    <!-- Active Group Actions Modal -->
    <div class="modal fade" id="group-actions-modal" tabindex="-1">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" data-i18n-key="group_actions_title">Group</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="ga-current" class="mb-2 small text-muted" data-i18n-key="group_actions_current">Active group:</p>
                    <div class="d-grid gap-2">
                        <button id="ga-change" class="btn btn-outline-primary" data-i18n-key="group_actions_change">Change Active Group</button>
                        <button id="ga-leave" class="btn btn-outline-danger" data-i18n-key="group_actions_leave">Leave Group</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Full-width banner (edge-to-edge) -->
    <div class="app-banner">
        <div class="container">
            <a href="#shortlist" class="d-flex align-items-center text-dark text-decoration-none">
                <span class="app-title fs-4 ms-2" data-i18n-key="title">Spiele, Bier & Brezel üé≤üç∫ü•®</span>
            </a>
        </div>
    </div>

    <div class="container">
        <header class="mb-4">

            <!-- (Banner moved to top of body for full-bleed styling) -->

            <!-- Navigation below the banner -->
            <div class="d-flex flex-wrap justify-content-between align-items-center">
                <ul class="nav nav-pills w-100" style="flex-wrap:wrap;">
                    <li class="nav-item d-none"><a href="#shortlist" class="nav-link" id="nav-shortlist" data-i18n-key="nav_shortlist">Shortlist</a></li>
                    <li class="nav-item d-none"><a href="#events" class="nav-link" id="nav-events" data-i18n-key="nav_events">Events</a></li>
                    <li class="nav-item d-none"><a href="#collection" class="nav-link" id="nav-collection" data-i18n-key="nav_collection">Whole Collection</a></li>
                    <li class="nav-item"><a href="#admin" class="nav-link d-none" id="nav-admin" data-i18n-key="nav_admin">Admin</a></li>
                    <li class="nav-item"><a href="#login" class="nav-link" id="nav-login" data-i18n-key="nav_login">Login</a></li>
                </ul>
            </div>
        </header>

    <!-- Group Join/Create Modal -->
    <div class="modal fade" id="group-modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" data-i18n-key="group_modal_title">Join or Create Group</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="small text-muted" data-i18n-key="group_modal_instruction">Enter an existing group code to join, or create a new group by providing a friendly name and an (optional) short join code.</p>
                    <div class="mb-3">
                        <label class="form-label" data-i18n-key="group_modal_enter_code_label">Enter Group Code</label>
                        <input type="text" id="group-join-code" class="form-control" placeholder="e.g., AB12CD" data-i18n-key="group_modal_enter_code_placeholder">
                        <div class="form-text" data-i18n-key="group_modal_enter_code_help">Enter a group join code to switch to that group.</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label" data-i18n-key="group_modal_choice_label">Or choose a group you belong to</label>
                        <select id="group-join-select" class="form-select">
                            <option value="">-- Select your group --</option>
                        </select>
                        <div class="form-text" data-i18n-key="group_modal_choice_help">If you're already a member, select the group here to switch quickly.</div>
                    </div>
                    <div id="group-modal-status" class="text-danger small"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n-key="group_modal_cancel">Cancel</button>
                    <button type="button" id="group-join-submit" class="btn btn-primary" data-i18n-key="group_modal_submit">Join / Create</button>
                </div>
            </div>
        </div>
    </div>

        <main>
            <!-- Login View -->
            <section id="login-view">
                <h2 data-i18n-key="login_heading">Login</h2>
                <div class="mb-3">
                    <label for="username-input" class="form-label" data-i18n-key="login_username_label">Enter your username or select existing</label>
                    <input type="text" id="username-input" class="form-control mb-2" placeholder="Enter new username" data-i18n-key="login_username_placeholder">
                    <select id="existing-users-dropdown" class="form-select d-none">
                        <option value="" data-i18n-key="login_select_user_placeholder">--- Select existing user ---</option>
                    </select>
                </div>
                <div class="input-group mb-3 d-none" id="password-field">
                    <input type="password" id="password-input" class="form-control" placeholder="Enter admin password" data-i18n-key="login_password_placeholder">
                </div>
                <button class="btn btn-primary" type="button" id="login-button" data-i18n-key="login_button">Login</button>
            </section>

            <!-- Collection View -->
            <section id="collection-view" class="d-none">
                <!-- Collection header and list (admin controls moved to Admin view) -->

                <div class="mb-3">
                    <h2 data-i18n-key="collection_heading">Game Collection</h2>
                    <p class="text-muted" data-i18n-key="collection_instruction">Browse the full collection of available games. Click the star to add a game to your personal wishlist.</p>
                    
                    <div class="row mb-3 align-items-end" id="filter-sort-controls">
                        <div class="col-md-6 col-lg-4 mb-2">
                            <input type="text" id="search-input" class="form-control" data-i18n-key="search_placeholder" placeholder="Search by name...">
                        </div>
                        <div class="col-md-6 col-lg-4 mb-2">
                            <div class="input-group">
                                <span class="input-group-text" data-i18n-key="sort_by_label">Sort by:</span>
                                <select id="sort-by-select" class="form-select">
                                    <option value="name_asc" data-i18n-key="sort_name_asc">Name (A-Z)</option>
                                    <option value="year_asc" data-i18n-key="sort_year_asc">Year (Oldest First)</option>
                                    <option value="year_desc" data-i18n-key="sort_year_desc">Year (Newest First)</option>
                                    <option value="min_players_asc" data-i18n-key="sort_min_players_asc">Min Players (Low to High)</option>
                                    <option value="max_players_asc" data-i18n-key="sort_max_players_asc">Max Players (Low to High)</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6 col-lg-4 mb-2 text-md-end">
                            <button class="btn btn-outline-secondary w-100 w-md-auto" type="button" data-bs-toggle="collapse" data-bs-target="#filter-collapse" aria-expanded="false" aria-controls="filter-collapse" data-i18n-key="filters_toggle">Filters</button>
                        </div>
                    </div>

                    <div class="collapse" id="filter-collapse">
                        <div class="card card-body mb-3">
                            <div class="row g-2 align-items-end">
                                <div class="col-md-6 col-lg-3">
                                    <div class="input-group">
                                        <span class="input-group-text" data-i18n-key="filter_min_players_label">Min Players:</span>
                                        <input type="number" id="min-players-filter" class="form-control" min="0">
                                    </div>
                                </div>
                                <div class="col-md-6 col-lg-3">
                                    <div class="input-group">
                                        <span class="input-group-text" data-i18n-key="filter_max_players_label">Max Players:</span>
                                        <input type="number" id="max-players-filter" class="form-control" min="0">
                                    </div>
                                </div>
                                <div class="col-md-6 col-lg-3">
                                    <div class="input-group">
                                        <span class="input-group-text" data-i18n-key="filter_max_playtime_label">Max Play Time (min):</span>
                                        <input type="number" id="max-playtime-filter" class="form-control" min="0">
                                    </div>
                                </div>
                                <div class="col-md-6 col-lg-3">
                                    <div class="input-group">
                                        <span class="input-group-text" data-i18n-key="filter_year_label">Year Published:</span>
                                        <input type="number" id="year-filter" class="form-control" min="1900" max="2100">
                                    </div>
                                </div>
                                <div class="col-12 col-lg-9 d-flex flex-wrap gap-2 mt-2">
                                    <button id="wishlist-filter-button" class="btn btn-outline-primary btn-sm d-none" data-i18n-key="wishlist_filter_button">My Wishlist</button>
                                </div>
                                <div class="col-12 col-lg-3 mt-2 text-lg-end">
                                    <button id="clear-filters-button" class="btn btn-outline-secondary w-100" data-i18n-key="clear_filters_button">Clear Filters</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between align-items-center mt-2">
                        <div class="btn-group me-2" role="group" id="layout-switcher">
                            <button type="button" class="btn btn-outline-secondary active" data-layout="large-grid" data-i18n-key="layout_large_grid">Large Grid</button>
                            <button type="button" class="btn btn-outline-secondary" data-layout="small-grid" data-i18n-key="layout_small_grid">Small Grid</button>
                            <button type="button" class="btn btn-outline-secondary" data-layout="list" data-i18n-key="layout_list">List</button>
                        </div>
                    </div>
                </div>

                <div id="game-collection" class="row">
                    <!-- Game cards from Firebase will be inserted here -->
                </div>
            </section>

            <!-- Group Edit View (Admin) -->
            <section id="group-edit-view" class="d-none">
                <div class="card p-3 mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h3 data-i18n-key="group_edit_heading">Edit Group</h3>
                        <button id="group-edit-cancel" class="btn btn-sm btn-outline-secondary" data-i18n-key="group_edit_back">Back to Admin</button>
                    </div>

                    <div class="mb-3">
                        <label for="group-edit-name" class="form-label" data-i18n-key="group_name_label">Group Name</label>
                        <input type="text" id="group-edit-name" class="form-control" placeholder="Friendly name for the group" data-i18n-key="group_name_placeholder">
                    </div>
                    <div class="mb-3">
                        <label for="group-edit-code" class="form-label" data-i18n-key="group_join_code_label">Join Code (optional)</label>
                        <input type="text" id="group-edit-code" class="form-control" placeholder="e.g., AB12CD" data-i18n-key="group_join_code_placeholder">
                    </div>
                    <div class="mb-3">
                        <label for="group-edit-desc" class="form-label" data-i18n-key="group_description_label">Description (optional)</label>
                        <textarea id="group-edit-desc" class="form-control" rows="3" placeholder="Description shown to members" data-i18n-key="group_description_placeholder"></textarea>
                    </div>

                                    <div class="mb-3">
                                        <h5 class="mb-2" data-i18n-key="group_members_heading">Members</h5>
                                        <div class="input-group mb-2">
                                            <input type="text" id="group-edit-add-username" class="form-control" placeholder="Enter username to add" data-i18n-key="group_add_member_placeholder">
                                            <button id="group-edit-add-btn" class="btn btn-outline-primary" data-i18n-key="group_add_member_button">Add</button>
                                        </div>
                                        <div id="group-edit-members" class="list-group mb-3">
                                            <div class="small text-muted" data-i18n-key="group_loading_members">Loading members...</div>
                                        </div>
                                    </div>

                    <div class="d-flex justify-content-between">
                        <div>
                            <button id="group-edit-save" class="btn btn-primary" data-i18n-key="group_save_button">Save</button>
                            <button id="group-edit-delete" class="btn btn-danger ms-2" data-i18n-key="group_delete_button">Delete</button>
                        </div>
                        <div class="text-muted small align-self-center" data-i18n-key="group_admin_only_note">Only visible to admin</div>
                    </div>
                </div>
            </section>

            <!-- Shortlist View -->
            <section id="shortlist-view" class="d-none">
                <div class="d-flex align-items-center justify-content-between mb-2">
                    <h2 class="mb-0" data-i18n-key="shortlist_heading">Game Shortlist</h2>
                    <div class="d-flex align-items-center">
                        <div id="next-game-label" class="text-muted small me-2 text-end" data-i18n-key="next_game_night_label">Next Game Night:</div>
                        <div id="next-game-night-container"></div>
                    </div>
                </div>
                <p class="text-muted" data-i18n-key="shortlist_instruction">Vote for the games you'd like to play at the next event!</p>
                <div id="shortlist-games" class="row"></div>
            </section>

            <!-- Admin View -->
            <section id="admin-view" class="d-none">
                <div id="admin-panel" class="card bg-light p-3 mb-4">
                    <h4 data-i18n-key="admin_heading">Admin Controls</h4>
                    <p data-i18n-key="admin_description">Update the group's shared game collection from a BGG XML file.</p>
                    <ol>
                        <li>
                            <strong data-i18n-key="admin_get_bgg_file">Get BGG File:</strong> 
                            <a href="https://boardgamegeek.com/xmlapi2/collection?username=leli84&own=1&stats=1" target="_blank" class="btn btn-secondary btn-sm" data-i18n-key="admin_get_bgg_file_button">Get BGG Collection File</a>
                            <small class="d-block text-muted" data-i18n-key="admin_get_bgg_file_help">If you see a "processing" message, wait a minute and refresh that page until the XML appears, then save the file.</small>
                        </li>
                        <li class="mt-2">
                            <strong data-i18n-key="admin_upload_file">Upload File:</strong>
                            <div class="input-group">
                                <input type="file" id="xml-file-input" class="form-control" accept=".xml">
                                <button id="upload-collection-button" class="btn btn-primary" data-i18n-key="admin_upload_button">Upload to Firebase</button>
                            </div>
                        </li>
                    </ol>
                    <div id="upload-status" class="mt-2"></div>
                    <div id="wishlist-summary" class="mt-3"></div>
                </div>

                <!-- API Settings section removed -->

                <!-- User Management (Admin-only) -->
                <div class="card bg-light p-3 mb-4">
                    <h4 data-i18n-key="user_management_heading">User Management</h4>
                    <p data-i18n-key="user_management_description">Manage registered users. Deleting a user will also remove their associated data (favorites, poll votes).</p>
                    <div id="user-list-container" class="list-group"></div>
                </div>

                <!-- Group Management (Admin-only) -->
                <div class="card bg-light p-3 mb-4" id="group-management">
                    <h4 data-i18n-key="group_management_heading">Group Management</h4>
                    <p class="small text-muted" data-i18n-key="group_management_description">Create, edit or delete groups. Only visible to admin.</p>
                    <div class="row g-2 align-items-end mb-3">
                        <div class="col-md-6">
                            <input type="text" id="admin-group-name" class="form-control" placeholder="Group name">
                        </div>
                        <div class="col-md-4">
                            <input type="text" id="admin-group-code" class="form-control" placeholder="Join code (optional)">
                        </div>
                        <div class="col-md-2">
                            <button id="admin-create-group" class="btn btn-primary w-100" data-i18n-key="admin_create_group_button">Create</button>
                        </div>
                    </div>
                    <div id="admin-groups-list" class="list-group"></div>
                </div>
            </section>

            <!-- Polls feature removed -->

            <!-- Events View -->
            <section id="events-view" class="d-none">
                <h2 data-i18n-key="events_heading">Calendar Events</h2>
                <p class="text-muted" data-i18n-key="events_instruction">Vote on the polls to help decide the date for the next event.</p>
                <button id="create-event-button" class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#create-event-modal" data-i18n-key="events_create_button">Create New Event</button>
                <div id="events-list"></div>

                <h2 class="mt-5" data-i18n-key="polls_heading">Event Date Polls</h2>
                <button id="create-poll-button" class="btn btn-success mb-3 d-none" data-bs-toggle="modal" data-bs-target="#create-poll-modal" data-i18n-key="polls_create_button">Create New Poll</button>
                <div id="polls-list"></div>
            </section>

        </main>
    </div>

    <!-- Create Event Modal -->
    <div class="modal fade" id="create-event-modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" data-i18n-key="modal_create_event_title">Create New Event</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="event-title" class="form-label" data-i18n-key="modal_event_title_label">Event Title</label>
                        <input type="text" class="form-control" id="event-title" placeholder="e.g., Board Game Night" data-i18n-key="modal_event_title_placeholder">
                    </div>
                    <div class="mb-3">
                        <label for="event-date" class="form-label" data-i18n-key="modal_date_label">Date</label>
                        <input type="date" class="form-control" id="event-date">
                    </div>
                    <div class="mb-3">
                        <label for="event-time" class="form-label" data-i18n-key="modal_time_label">Time</label>
                        <input type="time" class="form-control" id="event-time">
                    </div>
                    <div class="mb-3">
                        <label for="event-location" class="form-label" data-i18n-key="modal_location_label">Location</label>
                        <input type="text" class="form-control" id="event-location" placeholder="e.g., My place" data-i18n-key="modal_location_placeholder">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n-key="modal_close_button">Close</button>
                    <button type="button" class="btn btn-primary" id="save-event-button" data-i18n-key="modal_create_event_button">Create Event</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Poll Modal -->
    <div class="modal fade" id="create-poll-modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" data-i18n-key="modal_create_poll_title">Create New Poll</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="poll-title" class="form-label" data-i18n-key="modal_poll_title_label">Poll Title</label>
                        <input type="text" class="form-control" id="poll-title" placeholder="e.g., Next Game Night Date" data-i18n-key="modal_poll_title_placeholder">
                    </div>
                    <div id="poll-options-container">
                        <!-- Date options will be added here dynamically -->
                    </div>
                    <button class="btn btn-secondary btn-sm mt-2" id="add-poll-option" data-i18n-key="modal_add_poll_option_button">Add Date Option</button>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n-key="modal_close_button">Close</button>
                    <button type="button" class="btn btn-primary" id="save-poll-button" data-i18n-key="modal_create_poll_button">Create Poll</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Game Details Modal -->
    <div class="modal fade" id="game-details-modal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="game-modal-title" data-i18n-key="modal_game_details_title">Game Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="game-modal-body">
                    <!-- Game details will be loaded here -->
                </div>
                <div class="modal-footer d-flex justify-content-between">
                    <div id="modal-favorite-container">
                        <!-- Favorite button will be injected here -->
                    </div>
                    <button id="ai-summary-button" class="btn btn-info" data-i18n-key="modal_ai_summary_button">Generate AI Summary</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Use Firebase v8 for simplicity and compatibility -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="js/firebase-config.js?v=2.4"></script>
    <script src="js/ics.js?v=2.4"></script>
    <script src="js/bgg.js?v=2.4"></script>
    <script src="js/app.js?v=2.4" defer></script>
</body>
</html>
